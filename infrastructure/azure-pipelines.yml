trigger:
  paths:
    include:
    - infrastructure/

variables:
  - group: service_principals

pool:
  vmImage: 'ubuntu-latest'

strategy:
  maxParallel: 3
  matrix:
    test:
      stage: test
    dev:
      stage: dev
    prod:
      stage: prod

steps:
  - task: Bash@3
    displayName: Create dummy ssh key file
    inputs:
      workingDirectory: infrastructure
      targetType: 'inline'
      script: |
        rm -rf keys
        mkdir keys
        touch keys/key.pub
        ls keys

  - template: pipelines/templates/init.yml
    parameters:
      stage: $(stage)

  - task: Bash@3
    inputs:
      workingDirectory: infrastructure
      targetType: 'inline'
      script: terraform validate
    displayName: Validate Terraform
