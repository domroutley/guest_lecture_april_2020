trigger:
  paths:
    include:
    - infrastructure/

variables:
  - group: service_principals

pool:
  vmImage: 'ubuntu-latest'

strategy:
  maxParallel: 3
  matrix:
    test:
      env: test
    dev:
      env: dev
    prod:
      env: prod

steps:
  - task: Bash@3
    displayName: Create dummy ssh key file
    inputs:
      workingDirectory: infrastructure
      targetType: 'inline'
      script: |
        rm -rf keys
        mkdir keys
        touch keys/key.pub
        ls keys

  - template: templates/init.yml
    parameters:
      stage: $(env)

  - task: Bash@3
    inputs:
      workingDirectory: infrastructure
      targetType: 'inline'
      script: terraform validate
    displayName: Validate Terraform
